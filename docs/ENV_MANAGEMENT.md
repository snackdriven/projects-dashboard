# Environment Variable Management

## Overview

This monorepo uses an **inheritance-based approach** for managing environment variables across projects.

## Structure

```
projects-dashboard/
├── .env                          # Shared credentials (GITIGNORED)
├── .env.local                    # Local overrides (GITIGNORED)
├── scripts/
│   └── sync-env.sh              # Syncs env from root to projects
└── projects/
    └── quantified-life/
        ├── .env.defaults        # Project-specific defaults (COMMITTED)
        └── .env                 # Generated file (GITIGNORED)
```

## Files Explained

### Root `.env` (Gitignored)
**Location:** `/`
**Purpose:** Shared credentials used across multiple projects
**Contains:**
- Spotify OAuth credentials
- Google OAuth credentials
- Atlassian/JIRA credentials
- Other shared API keys

**Example:**
```bash
SPOTIFY_CLIENT_ID=your_spotify_client_id_here
SPOTIFY_CLIENT_SECRET=your_spotify_client_secret_here
GOOGLE_CLIENT_ID=your_google_client_id_here.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your_google_client_secret_here
```

### Project `.env.defaults` (Committed)
**Location:** `projects/{project-name}/.env.defaults`
**Purpose:** Project-specific configuration that's safe to commit
**Contains:**
- Server ports
- API endpoints
- Redirect URIs
- Feature flags
- Non-sensitive defaults

**Example (`projects/quantified-life/.env.defaults`):**
```bash
# Server Configuration
PORT=5179
NODE_ENV=development

# API Endpoints
CHRONICLE_API=http://localhost:3001/api/mcp/chronicle

# OAuth Redirect URIs (project-specific)
SPOTIFY_REDIRECT_URI=http://localhost:5179/callback/spotify
GOOGLE_REDIRECT_URI=http://localhost:5179/callback/google
```

### Project `.env` (Gitignored, Auto-generated)
**Location:** `projects/{project-name}/.env`
**Purpose:** Merged result of root `.env` + `.env.defaults`
**Generated by:** `./scripts/sync-env.sh`
**DO NOT EDIT:** Changes will be overwritten on next sync

## Usage

### Sync All Projects

```bash
pnpm env:sync
# or
./scripts/sync-env.sh --all
```

This syncs environment variables for all projects in the monorepo.

### Sync Specific Project

```bash
pnpm env:sync:quantified
# or
./scripts/sync-env.sh quantified-life
```

### When to Run Sync

Run sync whenever you:
1. **Update root `.env`** - Added/changed shared credentials
2. **Update project `.env.defaults`** - Changed project-specific config
3. **Add a new project** - Initialize its .env
4. **Pull changes** - After git pull that updated .env.defaults

### Recommended Workflow

```bash
# 1. Update shared credentials (if needed)
vim .env

# 2. Update project defaults (if needed)
vim projects/quantified-life/.env.defaults

# 3. Sync changes to all projects
pnpm env:sync

# 4. Commit .env.defaults (NOT .env)
git add projects/*/\.env.defaults
git commit -m "Update quantified-life env defaults"
```

## Adding a New Project

1. **Create `.env.defaults`:**
```bash
cat > projects/my-new-project/.env.defaults << 'EOF'
# Server Configuration
PORT=5181
NODE_ENV=development

# Project-specific settings
MY_PROJECT_SETTING=value
EOF
```

2. **Run sync:**
```bash
./scripts/sync-env.sh my-new-project
```

3. **Commit `.env.defaults`:**
```bash
git add projects/my-new-project/.env.defaults
git commit -m "Add env config for my-new-project"
```

## Variable Naming Conventions

### For Frontend (Vite)
**Prefix with `VITE_`** if you need the variable in browser:
```bash
VITE_API_BASE_URL=http://localhost:3000  # Available in React
```

### For Backend (Node.js)
**No prefix needed:**
```bash
PORT=5179                    # Server-side only
SPOTIFY_CLIENT_SECRET=xxx    # Server-side only (never expose!)
```

## Security Best Practices

### ✅ Safe to Commit
- `.env.defaults` - Non-sensitive project config
- `.env.example` - Template files with placeholders

### ❌ NEVER Commit
- `.env` - Contains real credentials
- `.env.local` - Local overrides
- `.env.production` - Production credentials

### Credential Storage
1. **Development:** Store in root `.env` (gitignored)
2. **Production:** Use environment variables from hosting platform (Vercel, Netlify, etc.)
3. **Team sharing:** Use secure vault (1Password, Doppler, AWS Secrets Manager)

## Troubleshooting

### "Environment variable not found"

**Cause:** Project .env not synced or variable missing from root

**Fix:**
```bash
# Check if variable exists in root .env
grep VARIABLE_NAME .env

# Sync project
./scripts/sync-env.sh quantified-life

# Verify generated file
cat projects/quantified-life/.env | grep VARIABLE_NAME
```

### ".env has duplicate variables"

**Cause:** Variable defined in both root .env and .env.defaults

**Fix:** Choose one location:
- Shared credentials → Root `.env`
- Project-specific → `.env.defaults`

Note: .env.defaults overrides root .env (last value wins)

### "Changes to .env keep getting overwritten"

**Cause:** Editing generated `.env` instead of source files

**Fix:** Edit source files and re-sync:
```bash
# Edit root .env for shared credentials
vim .env

# Edit .env.defaults for project config
vim projects/quantified-life/.env.defaults

# Re-sync
pnpm env:sync:quantified
```

## Advanced: Custom Variable Filtering

To customize which variables are synced, edit `scripts/sync-env.sh`:

```bash
# Example: Add AWS credentials
grep -E '^AWS_' "$ROOT_ENV" >> "$PROJECT_ENV" || true
```

## Integration with CI/CD

### GitHub Actions Example

```yaml
name: Build
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # Populate .env from GitHub Secrets
      - name: Create .env
        run: |
          echo "SPOTIFY_CLIENT_ID=${{ secrets.SPOTIFY_CLIENT_ID }}" >> .env
          echo "SPOTIFY_CLIENT_SECRET=${{ secrets.SPOTIFY_CLIENT_SECRET }}" >> .env
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
          echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env

      # Sync to all projects
      - name: Sync env to projects
        run: pnpm env:sync

      # Build
      - name: Build
        run: pnpm build:all
```

## Related Commands

| Command | Description |
|---------|-------------|
| `pnpm env:sync` | Sync all projects |
| `pnpm env:sync:quantified` | Sync quantified-life only |
| `./scripts/sync-env.sh --all` | Direct script execution |
| `./scripts/sync-env.sh <project>` | Sync specific project |

## See Also

- [Credential Setup Guide](../credential_setup.md) - How to obtain API credentials
- [Adding Projects](../adding_projects.md) - Creating new projects in monorepo
- [Monorepo Setup](../monorepo_setup.md) - Overall monorepo architecture
